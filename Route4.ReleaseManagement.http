### Route4 Release Management & Ritual Mapping API Tests
### Phase 4 Implementation - Testing Guide

@baseUrl = http://localhost:5158
@clientSlug = making-of-mary

### ============================================
### PHASE 4: RITUAL MAPPING
### ============================================

### 1. Get Mary's Ritual Sequence (should show all 9 rituals)
GET {{baseUrl}}/api/admin/clients/{{clientSlug}}/releases/mary-ritual-sequence
Content-Type: application/json

### 2. List all Ritual Mappings for Mary
GET {{baseUrl}}/api/admin/clients/{{clientSlug}}/releases/ritual-mappings
Content-Type: application/json

### ============================================
### RELEASE MANAGEMENT
### ============================================

### 3. Create a New Release Instance (S1E1)
POST {{baseUrl}}/api/admin/clients/{{clientSlug}}/releases
Content-Type: application/json

{
  "releaseKey": "S1E1",
  "title": "Pilot Episode",
  "description": "The first episode of Making of Mary",
  "scheduledStartAt": "2026-01-15T00:00:00Z"
}

### 4. List All Releases for Making of Mary
GET {{baseUrl}}/api/admin/clients/{{clientSlug}}/releases
Content-Type: application/json

### 5. Get Specific Release (replace with actual GUID from step 3)
@releaseId = YOUR_RELEASE_ID_HERE
GET {{baseUrl}}/api/admin/clients/{{clientSlug}}/releases/{{releaseId}}
Content-Type: application/json

### 6. Get Available Next Stages (should show valid transitions)
GET {{baseUrl}}/api/admin/clients/{{clientSlug}}/releases/{{releaseId}}/next-stages
Content-Type: application/json

### 7. Advance Release from Draft → Signal
POST {{baseUrl}}/api/admin/clients/{{clientSlug}}/releases/{{releaseId}}/advance
Content-Type: application/json

{
  "targetStage": "Signal",
  "notes": "Starting the ritual sequence"
}

### 8. Advance Release from Signal → Process
POST {{baseUrl}}/api/admin/clients/{{clientSlug}}/releases/{{releaseId}}/advance
Content-Type: application/json

{
  "targetStage": "Process",
  "notes": "Opening process rooms for Writing Table"
}

### 9. Advance Release from Process → Hold
POST {{baseUrl}}/api/admin/clients/{{clientSlug}}/releases/{{releaseId}}/advance
Content-Type: application/json

{
  "targetStage": "Hold",
  "notes": "Entering intentional silence"
}

### 10. Advance Release from Hold → Drop (THE PRIMARY RELEASE)
POST {{baseUrl}}/api/admin/clients/{{clientSlug}}/releases/{{releaseId}}/advance
Content-Type: application/json

{
  "targetStage": "Drop",
  "notes": "Episode is live - read-only window begins"
}

### 11. Advance Release from Drop → Echo (Reflection Opens)
POST {{baseUrl}}/api/admin/clients/{{clientSlug}}/releases/{{releaseId}}/advance
Content-Type: application/json

{
  "targetStage": "Echo",
  "notes": "24h window complete - opening reflection"
}

### 12. Get Release State Transition History (Audit Trail)
GET {{baseUrl}}/api/admin/clients/{{clientSlug}}/releases/{{releaseId}}/history
Content-Type: application/json

### ============================================
### RITUAL MAPPING CRUD
### ============================================

### 13. Create a Custom Ritual Mapping (Optional)
@templateId = YOUR_TEMPLATE_ID_HERE
POST {{baseUrl}}/api/admin/clients/{{clientSlug}}/releases/ritual-mappings
Content-Type: application/json

{
  "releaseCycleTemplateId": "{{templateId}}",
  "ritualName": "CustomRitual",
  "stageType": "Custom",
  "description": "A custom ritual for testing",
  "executionOrder": 99,
  "targetChannelPurpose": "custom",
  "visibilityLevel": "L2",
  "isReadOnly": true,
  "defaultDurationHours": 12,
  "automaticallyUnlockChannel": true,
  "automaticallyLockChannel": true,
  "slowModeSeconds": "15",
  "disableFileUploads": false,
  "disableExternalEmojis": false,
  "announcementMessage": "Custom ritual announcement",
  "closingMessage": "Custom ritual closing",
  "isAnonymous": false,
  "canBeSkipped": true
}

### 14. Update Ritual Mapping
@mappingId = YOUR_MAPPING_ID_HERE
PUT {{baseUrl}}/api/admin/clients/{{clientSlug}}/releases/ritual-mappings/{{mappingId}}
Content-Type: application/json

{
  "announcementMessage": "Updated announcement message",
  "defaultDurationHours": 48
}

### ============================================
### DISCORD INTEGRATION (PHASE 2)
### ============================================

### 15. Get Bot Invitation (Step 1)
GET {{baseUrl}}/api/admin/clients/{{clientSlug}}/release-engine/bot-invitation
Content-Type: application/json

### 16. Configure Existing Discord Server (Step 2)
POST {{baseUrl}}/api/admin/clients/{{clientSlug}}/release-engine/configure-existing-server
Content-Type: application/json

{
  "guildId": "YOUR_DISCORD_SERVER_ID",
  "botToken": "YOUR_BOT_TOKEN",
  "languagePack": "making-of-mary"
}

### 17. Get Client Review (Phase 5)
GET {{baseUrl}}/api/admin/clients/{{clientSlug}}/release-engine/review
Content-Type: application/json

### ============================================
### TESTING NOTES
### ============================================

# Expected Flow:
# 1. Create a release (step 3)
# 2. Get the releaseId from the response
# 3. Replace {{releaseId}} in subsequent requests
# 4. Advance through stages (steps 7-11)
# 5. Check history after each transition (step 12)

# Discord Automation:
# - When advancing stages, check the logs for Discord automation
# - Channels should unlock/lock based on ritual mappings
# - Announcements should be sent automatically
# - Slow mode should be applied where configured

# Ritual Mappings:
# - 9 core Mary rituals are seeded automatically
# - Signal → Process → Hold → Drop → Echo → Fragments → Interval → PrivateViewing → Archive
# - Each has specific Discord automation rules
# - View with GET mary-ritual-sequence (step 1)

# State Machine Validation:
# - Invalid transitions will be rejected (e.g., Draft → Drop)
# - Valid transitions are defined in ReleaseStateMachine
# - Check available next stages with step 6

### ============================================
### ARCHITECTURE ALIGNMENT
### ============================================

# This implementation follows the Route4 design doc:
# - Phase 4: Ritual Mapping ✅
# - Release state machine ✅
# - Discord automation triggers ✅
# - Audit trail (state transitions) ✅
# - Mary's 9 ritual sequence ✅
# - Visibility levels (L0-L3) ✅
# - Channel purpose mapping ✅
# - Announcement automation ✅
